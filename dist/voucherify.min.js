window.Voucherify=function(e,t,n){"use strict";function o(e){return e&&("boolean"==typeof e.valid||"string"==typeof e.result||"object"==typeof e.voucher||"object"==typeof e.vouchers)}function r(e){return Math.round(100.001*e)/100}function i(e){if(!e||0>e||e>100)throw new Error("Invalid voucher, percent discount should be between 0-100.")}function a(e){if(!e||0>e)throw new Error("Invalid voucher, amount discount must be higher than zero.")}function s(e){if(!e||0>e)throw new Error("Invalid voucher, unit discount must be higher than zero.")}function c(e){return e.applicationId?e.applicationId?!0:(console.error("Voucherify.js ERROR: Missing Client Token (Secret Key)."),!1):(console.error("Voucherify.js ERROR: Missing Client Application ID."),!1)}var l="https://api.voucherify.io",u={validate:l+"/client/v1/validate",redeem:l+"/client/v1/redeem",publish:l+"/client/v1/publish",list:l+"/client/v1/vouchers"},d={},p="invalid_customer_phone",f=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,h=null;h=n&&"function"==typeof n.ajax&&n.Deferred?function(e,t,r,i){var a=null;return"function"!=typeof i&&(a=n.Deferred()),n.ajax({type:e,url:t,data:JSON.stringify(r),xhrFields:{withCredentials:!0},dataType:"json",headers:{Accept:"application/json","Content-Type":"application/json","X-Client-Application-Id":d.applicationId,"X-Client-Token":d.token,"X-Voucherify-Channel":"Voucherify.js"},timeout:d.timeout,success:function(e){var t=null;o(e)?"function"==typeof i?i(e):a.resolve(e):(t={type:"error",message:"Unexpected response structure.",context:e},"function"==typeof i?i(t):a.reject(t))},error:function(e){var t={type:"error",message:"XHR error happened.",context:e};"function"==typeof i?i(t):a.reject(t)}}),"function"!=typeof i?a.promise():void 0}:function(t,n,r,i){var a=new e.XMLHttpRequest;a.withCredentials=!0,a.open(t,n,!0),a.timeout=d.timeout,a.setRequestHeader("Accept","application/json"),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("X-Client-Application-Id",d.applicationId),a.setRequestHeader("X-Client-Token",d.token),a.setRequestHeader("X-Voucherify-Channel","Voucherify.js"),a.onload=function(){var e=null;if(a.status>=200&&a.status<400){var t=JSON.parse(a.responseText);o(t)?"function"==typeof i&&i(t):(e={type:"error",message:"Unexpected response structure.",context:t},"function"==typeof i&&i(e))}else e={type:"error",message:"Unexpected status code.",context:a.status},"function"==typeof i&&i(e)},a.onerror=function(e){var t={type:"error",message:"XHR error happened.",context:e};"function"==typeof i&&i(t)},a.send(JSON.stringify(r))};var m={initialize:function(e,t,n){d.applicationId=e,d.token=t,d.timeout=n||5e3},setIdentity:function(e){d.trackingId=e},validate:function(e,t){if(!c(d))return null;var n,o,r,i;if("object"==typeof e&&(n=e.amount,o=e.items,r=e.metadata,i=e.customer,e=e.code),e&&(e=e.replace(/[\s\r\n]/g,"")),!e)return console.error("Voucherify client could not verify code, because it is missing - please provide Voucher Code."),null;var a="?code="+encodeURIComponent(e);return n&&(a+="&amount="+parseInt(n)),o&&(a+="&"+o.map(function(e,t){return Object.keys(e).map(function(n){return encodeURIComponent("item["+t+"]["+n+"]")+"="+encodeURIComponent(e[n])}).join("&")}).join("&")),r&&(a+="&"+Object.keys(r).map(function(e){return encodeURIComponent("metadata["+e+"]")+"="+encodeURIComponent(r[e])}).join("&")),i&&(a+="&"+Object.keys(i).map(function(e){return encodeURIComponent("customer["+e+"]")+"="+encodeURIComponent(i[e])}).join("&")),d.trackingId&&(a+="&tracking_id="+encodeURIComponent(d.trackingId)),h("GET",u.validate+a,void 0,t)},redeem:function(e,t,n){if(!c(d))return null;if(!e)return console.error("Voucherify client could not verify code, because it is missing - please provide Voucher Code."),null;var o="?code="+encodeURIComponent(e.replace(/[\s\r\n]/g,""));return t=t||{},t.customer=t.customer||{},t.customer.source_id=t.customer.source_id||d.trackingId,h("POST",u.redeem+o,t,n)},publish:function(e,t,n){if(!c(d))return null;if(!e)return console.error("Voucherify.js ERROR: campaign is required to publish a voucher."),null;var o="?campaign="+encodeURIComponent(e);return t=t||{},t.customer=t.customer||{},t.customer.source_id=t.customer.source_id||d.trackingId,t.channel=t.channel||"Voucherify.js",h("POST",u.publish+o,t,n)},listVouchers:function(e,t){if(!c(d))return null;"function"!=typeof e||t||(t=e,e={});var n="?"+Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&");return h("GET",u.list+n,void 0,t)},utils:{calculatePrice:function(e,t,n){var o,c=100;if(t.gift)return o=Math.min(t.gift.balance/c,e),r(e-o);if(!t.discount)throw new Error("Unsupported voucher type.");if("PERCENT"===t.discount.type){o=t.discount.percent_off,i(o);var l=e*(o/100);return r(e-l)}if("AMOUNT"===t.discount.type){o=t.discount.amount_off/c,a(o);var u=e-o;return r(u>0?u:0)}if("UNIT"===t.discount.type){o=t.discount.unit_off,s(o);var u=e-n*o;return r(u>0?u:0)}throw new Error("Unsupported discount type.")},calculateDiscount:function(e,t,n){var o,c=100;if(t.gift)return o=Math.min(t.gift.balance/c,e),r(o);if(!t.discount)throw new Error("Unsupported voucher type.");if("PERCENT"===t.discount.type)return o=t.discount.percent_off,i(o),r(e*(o/100));if("AMOUNT"===t.discount.type){o=t.discount.amount_off/c,a(o);var l=e-o;return r(l>0?o:e)}if("UNIT"===t.discount.type){o=t.discount.unit_off,s(o);var u=n*o;return r(u>e?e:u)}throw new Error("Unsupported discount type.")}},render:function(e,o){function r(e){return e.charAt(0).toUpperCase()+e.slice(1)}function i(e,t){return e+r(t)}function a(e,t){return o[i(e,t)]}function s(e,o,r,s){s=s||{};var c=null,l=a("selector",o);if(s.configurable&&l&&(c=n(l)),!c||!c.length){c=n(t.createElement(e)),r.append(c);for(var u in s)"configurable"!==u&&s.hasOwnProperty(u)&&c.attr(u,s[u]);"input"===e&&c.attr("name",i("voucherify",o)),"span"===e&&s.text&&c.text(s.text)}return c.addClass("string"==typeof a("class",o)?a("class",o):i("voucherify",o)),c}var c=n(e);if(!c||!c.length)throw new Error("Element '"+e+"' cannot be found");o=o||{};var l=s("div","container",c),u=s("figure","logo",l),d=(s("img","logo",u,{src:"string"==typeof o.logoSrc?o.logoSrc:"https://app.voucherify.io/images/favicon.png"}),s("input","code",l,{type:"text",placeholder:"string"==typeof o.textPlaceholder?o.textPlaceholder:"e.g. abc-123"})),p=s("input","discountType",l,{type:"hidden",configurable:!0}),f=s("input","percentOff",l,{type:"hidden",configurable:!0}),h=s("input","amountOff",l,{type:"hidden",configurable:!0}),m=s("input","unitOff",l,{type:"hidden",configurable:!0}),v=s("input","tracking",l,{type:"hidden",configurable:!0}),g=s("button","validate",l,{}),y=(s("span","validateText",g,{text:"string"==typeof o.textValidate?o.textValidate:"Validate"}),this),C="string"===o.classInvalid?o.classInvalid:"voucherifyInvalid",b="string"==typeof o.classValid?o.classValid:"voucherifyValid",I="string"===o.classInvalidAnimation?o.classInvalidAnimation:"voucherifyAnimationShake",x="string"===o.classValidAnimation?o.classValidAnimation:"voucherifyAnimationTada";d.on("keyup",function(e){d.toggleClass(I,!1)}),g.on("click",function(e){return p.val(""),h.val(""),m.val(""),f.val(""),v.val(""),g.toggleClass(C,!1),g.toggleClass(b,!1),d.val()?void y.validate(d.val(),function(e){return e&&e.valid?(d.toggleClass(C,!1),p.val(e.discount&&e.discount.type||""),h.val(e.discount&&e.discount.amount_off||0),m.val(e.discount&&e.discount.unit_off||0),f.val(e.discount&&e.discount.percent_off||0),v.val(e.tracking_id||""),d.prop("disabled",!0),g.prop("disabled",!0),d.toggleClass(b,!0),g.toggleClass(b,!0),g.toggleClass(C,!1),d.toggleClass(C,!1),d.toggleClass(x,!0),void(o&&o.onValidated&&"function"==typeof o.onValidated&&o.onValidated(e))):(g.toggleClass(C,!0),g.toggleClass(b,!1),d.toggleClass(C,!0),d.toggleClass(b,!1),void d.toggleClass(I,!0).delay(1e3).queue(function(){d.toggleClass(I,!1),d.dequeue()}))}):void d.toggleClass(I,!0).delay(1e3).queue(function(){d.toggleClass(I,!1),d.dequeue()})})},renderPublish:function(e,o){function r(e,t){return Array.prototype.some.call(e||[],function(e){return e.name===t})}function i(e){return r(o.customerFields,e)}function a(e){var t=Array.prototype.find.call(o.customerFields||[],function(t){return t.name===e});return t&&t.required||!1}function s(e){return e.charAt(0).toUpperCase()+e.slice(1)}function c(e,t){return e+s(t)}function l(e,t){return o[c(e,t)]}function u(e,o,r,i){i=i||{};var a=null,s=l("selector",o);if(i.configurable&&s&&(a=n(s)),!a||!a.length){a=n(t.createElement(e)),r.append(a);for(var u in i)"configurable"!==u&&i.hasOwnProperty(u)&&a.attr(u,i[u]);"input"===e&&a.attr("name",c("voucherify",o)),"span"===e&&i.text&&a.text(i.text)}return a.addClass("string"==typeof l("class",o)?l("class",o):c("voucherify",o)),a}function d(e){e.toggleClass(T,!0),e.toggleClass(O,!1),e.toggleClass(S,!0).delay(1e3).queue(function(){e.toggleClass(S,!1),e.toggleClass(T,!1),e.toggleClass(O,!1),e.dequeue()})}var h=n(e);if(!h||!h.length)throw new Error("Element '"+e+"' cannot be found");if(o=o||{},!o.campaignName)throw new Error("Option campaignName is not specified");var m=u("div","container",h);m.addClass("wide");{var v=u("figure","logo",m),g=(u("img","logo",v,{src:"string"==typeof o.logoSrc?o.logoSrc:"https://app.voucherify.io/images/favicon.png"}),i("name")&&u("input","customerName",m,{type:"text",placeholder:"string"==typeof o.customerNamePlaceholder?o.customerNamePlaceholder:"Name"})),y=u("div","row",m),C=i("email")&&u("input","customerEmail",y,{type:"email",placeholder:"string"==typeof o.customerEmailPlaceholder?o.customerEmailPlaceholder:"Email"}),b=i("phone")&&u("input","customerPhone",y,{type:"text",placeholder:"string"==typeof o.customerPhonePlaceholder?o.customerPhonePlaceholder:"Phone"}),I=i("line_1")&&u("input","customerLine1",m,{type:"text",placeholder:"string"==typeof o.customerLine1Placeholder?o.customerLine1Placeholder:"Address line 1"}),x=i("line_2")&&u("input","customerLine2",m,{type:"text",placeholder:"string"==typeof o.customerLine2Placeholder?o.customerLine2Placeholder:"Address line 2"}),P=u("div","row",m),w=i("postal_code")&&u("input","customerPostalCode",P,{type:"text",placeholder:"string"==typeof o.customerPostalCodePlaceholder?o.customerPostalCodePlaceholder:"Postal Code"}),_=i("city")&&u("input","customerCity",P,{type:"text",placeholder:"string"==typeof o.customerCityPlaceholder?o.customerCityPlaceholder:"City"}),R=u("div","row",m),V=i("state")&&u("input","customerState",R,{type:"text",placeholder:"string"==typeof o.customerStatePlaceholder?o.customerStatePlaceholder:"State"}),j=i("country")&&u("input","customerCountry",R,{type:"text",placeholder:"string"==typeof o.customerCountryPlaceholder?o.customerCountryPlaceholder:"Country"}),A=u("input","tracking",m,{type:"hidden",configurable:!0}),E=u("input","publishStatus",m,{type:"text"}),k=u("button","publish",m,{});u("span","publishText",k,{text:"string"==typeof o.textPublish?o.textPublish:"Get voucher"})}E.prop("readonly",!0).hide();var U=this,T="string"===o.classInvalid?o.classInvalid:"voucherifyInvalid",O="string"==typeof o.classValid?o.classValid:"voucherifyValid",S="string"===o.classInvalidAnimation?o.classInvalidAnimation:"voucherifyAnimationShake",N="string"===o.classValidAnimation?o.classValidAnimation:"voucherifyAnimationTada";k.on("click",function(e){A.val(""),k.toggleClass(T,!1),k.toggleClass(O,!1);var t={customer:{}};if(i("name")){if(!g.val()&&a("name"))return d(g);t.customer.name=g.val()}if(i("email")){if(!C.val()&&a("email"))return d(C);if(C.val()&&!f.test(C.val()))return d(C);t.customer.email=C.val(),t.customer.source_id=t.customer.email}if(i("phone")){if(!b.val()&&a("phone"))return d(b);b.val()&&(t.customer.phone=b.val())}if((i("line_1")||i("line_2")||i("postal_code")||i("city")||i("state")||i("country"))&&(t.customer.address={}),i("line_1")){if(!I.val()&&a("line_1"))return d(I);t.customer.address.line_1=I.val()}if(i("line_2")){if(!x.val()&&a("line_2"))return d(x);t.customer.address.line_2=x.val()}if(i("postal_code")){if(!w.val()&&a("postal_code"))return d(w);t.customer.address.postal_code=w.val()}if(i("city")){if(!_.val()&&a("city"))return d(_);t.customer.address.city=_.val()}if(i("state")){if(!V.val()&&a("state"))return d(V);t.customer.address.state=V.val()}if(i("country")){if(!j.val()&&a("country"))return d(j);t.customer.address.country=j.val()}U.publish(o.campaignName,t,function(e){if(!e||!e.voucher||!e.voucher.code){var t=e.context||{},n=t.responseJSON||{},r=n.key;return d(k),void(i("phone")&&r===p&&d(b))}g&&g.hide(),C&&C.hide(),b&&b.hide(),I&&I.hide(),x&&x.hide(),w&&w.hide(),_&&_.hide(),V&&V.hide(),j&&j.hide(),E.toggleClass(N,!0).val(e.voucher.code).show(100),A.val(e.tracking_id||""),k.prop("disabled",!0),k.toggleClass(T,!1).hide(),o&&o.onPublished&&"function"==typeof o.onPublished&&o.onPublished(e)})})}};return"undefined"!=typeof module&&module.exports&&(module.exports=m),m}(window,window.document,window.jQuery);
//# sourceMappingURL=voucherify.min.js.map
