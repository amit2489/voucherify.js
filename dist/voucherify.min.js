window.Voucherify=function(e,t,n){"use strict";function o(e){return e&&("boolean"==typeof e.valid||"string"==typeof e.result||"object"==typeof e.voucher||"object"==typeof e.vouchers)}function i(e){return Math.round(100.001*e)/100}function r(e){if(!e||0>e||e>100)throw new Error("Invalid voucher, percent discount should be between 0-100.")}function a(e){if(!e||0>e)throw new Error("Invalid voucher, amount discount must be higher than zero.")}function u(e){if(!e||0>e)throw new Error("Invalid voucher, unit discount must be higher than zero.")}function c(e){return e.applicationId?e.applicationId?!0:(console.error("Voucherify.js ERROR: Missing Client Token (Secret Key)."),!1):(console.error("Voucherify.js ERROR: Missing Client Application ID."),!1)}var s="https://api.voucherify.io",l={validate:s+"/client/v1/validate",redeem:s+"/client/v1/redeem",publish:s+"/client/v1/publish",list:s+"/client/v1/vouchers"},d={},p="invalid_amount",f="invalid_number",g="missing_amount",v=null;v=n&&"function"==typeof n.ajax&&n.Deferred?function(e,t,i,r){var a=null;return"function"!=typeof r&&(a=n.Deferred()),n.ajax({type:e,url:t,data:JSON.stringify(i),xhrFields:{withCredentials:!0},dataType:"json",headers:{Accept:"application/json","Content-Type":"application/json","X-Client-Application-Id":d.applicationId,"X-Client-Token":d.token,"X-Voucherify-Channel":"Voucherify.js"},timeout:d.timeout,success:function(e){var t=null;o(e)?"function"==typeof r?r(e):a.resolve(e):(t={type:"error",message:"Unexpected response structure.",context:e},"function"==typeof r?r(t):a.reject(t))},error:function(e){var t={type:"error",message:"XHR error happened.",context:e};"function"==typeof r?r(t):a.reject(t)}}),"function"!=typeof r?a.promise():void 0}:function(t,n,i,r){var a=new e.XMLHttpRequest;a.withCredentials=!0,a.open(t,n,!0),a.timeout=d.timeout,a.setRequestHeader("Accept","application/json"),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("X-Client-Application-Id",d.applicationId),a.setRequestHeader("X-Client-Token",d.token),a.setRequestHeader("X-Voucherify-Channel","Voucherify.js"),a.onload=function(){var e=null;if(a.status>=200&&a.status<400){var t=JSON.parse(a.responseText);o(t)?"function"==typeof r&&r(t):(e={type:"error",message:"Unexpected response structure.",context:t},"function"==typeof r&&r(e))}else e={type:"error",message:"Unexpected status code.",context:a.status},"function"==typeof r&&r(e)},a.onerror=function(e){var t={type:"error",message:"XHR error happened.",context:e};"function"==typeof r&&r(t)},a.send(JSON.stringify(i))};var y={initialize:function(e,t,n){d.applicationId=e,d.token=t,d.timeout=n||5e3},setIdentity:function(e){d.trackingId=e},validate:function(e,t){if(!c(d))return null;var n,o,i,r;if("object"==typeof e&&(n=e.amount,o=e.items,i=e.metadata,r=e.customer,e=e.code),e&&(e=e.replace(/[\s\r\n]/g,"")),!e)return console.error("Voucherify client could not verify code, because it is missing - please provide Voucher Code."),null;var a="?code="+encodeURIComponent(e);return n&&(a+="&amount="+parseInt(n)),o&&(a+="&"+o.map(function(e,t){return Object.keys(e).map(function(n){return encodeURIComponent("item["+t+"]["+n+"]")+"="+encodeURIComponent(e[n])}).join("&")}).join("&")),i&&(a+="&"+Object.keys(i).map(function(e){return encodeURIComponent("metadata["+e+"]")+"="+encodeURIComponent(i[e])}).join("&")),r&&(a+="&"+Object.keys(r).map(function(e){return encodeURIComponent("customer["+e+"]")+"="+encodeURIComponent(r[e])}).join("&")),d.trackingId&&(a+="&tracking_id="+encodeURIComponent(d.trackingId)),v("GET",l.validate+a,void 0,t)},redeem:function(e,t,n){if(!c(d))return null;if(!e)return console.error("Voucherify client could not verify code, because it is missing - please provide Voucher Code."),null;var o="?code="+encodeURIComponent(e.replace(/[\s\r\n]/g,""));return t=t||{},t.customer=t.customer||{},t.customer.source_id=t.customer.source_id||d.trackingId,v("POST",l.redeem+o,t,n)},publish:function(e,t,n){if(!c(d))return null;if(!e)return console.error("Voucherify.js ERROR: campaign is required to publish a voucher."),null;var o="?campaign="+encodeURIComponent(e);return t=t||{},t.customer=t.customer||{},t.customer.source_id=t.customer.source_id||d.trackingId,t.channel=t.channel||"Voucherify.js",v("POST",l.publish+o,t,n)},listVouchers:function(e,t){if(!c(d))return null;"function"!=typeof e||t||(t=e,e={});var n="?"+Object.keys(e).map(function(t){return encodeURIComponent(t)+"="+encodeURIComponent(e[t])}).join("&");return v("GET",l.list+n,void 0,t)},utils:{calculatePrice:function(e,t,n){var o,c=100;if(t.gift)return o=Math.min(t.gift.balance/c,e),i(e-o);if(!t.discount)throw new Error("Unsupported voucher type.");if("PERCENT"===t.discount.type){o=t.discount.percent_off,r(o);var s=e*(o/100);return i(e-s)}if("AMOUNT"===t.discount.type){o=t.discount.amount_off/c,a(o);var l=e-o;return i(l>0?l:0)}if("UNIT"===t.discount.type){o=t.discount.unit_off,u(o);var l=e-n*o;return i(l>0?l:0)}throw new Error("Unsupported discount type.")},calculateDiscount:function(e,t,n){var o,c=100;if(t.gift)return o=Math.min(t.gift.balance/c,e),i(o);if(!t.discount)throw new Error("Unsupported voucher type.");if("PERCENT"===t.discount.type)return o=t.discount.percent_off,r(o),i(e*(o/100));if("AMOUNT"===t.discount.type){o=t.discount.amount_off/c,a(o);var s=e-o;return i(s>0?o:e)}if("UNIT"===t.discount.type){o=t.discount.unit_off,u(o);var l=n*o;return i(l>e?e:l)}throw new Error("Unsupported discount type.")}},render:function(e,o){function i(e){return e.charAt(0).toUpperCase()+e.slice(1)}function r(e,t){return e+i(t)}function a(e,t){return o[r(e,t)]}function u(e,o,i,u){u=u||{};var c=null,s=a("selector",o);if(u.configurable&&s&&(c=n(s)),!c||!c.length){c=n(t.createElement(e)),i.append(c);for(var l in u)"configurable"!==l&&u.hasOwnProperty(l)&&c.attr(l,u[l]);"input"===e&&c.attr("name",r("voucherify",o)),"span"===e&&u.text&&c.text(u.text)}return c.addClass("string"==typeof a("class",o)?a("class",o):r("voucherify",o)),c}var c=n(e);if(!c||!c.length)throw new Error("Element '"+e+"' cannot be found");o=o||{};var s=u("div","container",c),l=u("figure","logo",s),d=(u("img","logo",l,{src:"string"==typeof o.logoSrc?o.logoSrc:"https://app.voucherify.io/images/favicon.png"}),u("input","code",s,{type:"text",placeholder:"string"==typeof o.textPlaceholder?o.textPlaceholder:"e.g. abc-123"})),v=u("input","amount",s,{type:o.amount?"text":"hidden",placeholder:"string"==typeof o.amountPlaceholder?o.amountPlaceholder:"e.g. 52.22"}),y=u("input","discountType",s,{type:"hidden",configurable:!0}),m=u("input","percentOff",s,{type:"hidden",configurable:!0}),h=u("input","amountOff",s,{type:"hidden",configurable:!0}),C=u("input","unitOff",s,{type:"hidden",configurable:!0}),I=u("input","tracking",s,{type:"hidden",configurable:!0}),b=u("button","validate",s,{}),R=(u("span","validateText",b,{text:"string"==typeof o.textValidate?o.textValidate:"Validate"}),this),w="string"===o.classInvalid?o.classInvalid:"voucherifyInvalid",j="string"==typeof o.classValid?o.classValid:"voucherifyValid",x="string"===o.classInvalidAnimation?o.classInvalidAnimation:"voucherifyAnimationShake",V="string"===o.classValidAnimation?o.classValidAnimation:"voucherifyAnimationTada";d.on("keyup",function(e){d.toggleClass(x,!1)}),v.on("keyup",function(e){v.toggleClass(x,!1)}),b.on("click",function(e){if(y.val(""),h.val(""),C.val(""),m.val(""),I.val(""),b.toggleClass(w,!1),b.toggleClass(j,!1),!d.val())return void d.toggleClass(x,!0).delay(1e3).queue(function(){d.toggleClass(x,!1),d.dequeue()});var t={code:d.val(),amount:parseInt(100*parseFloat(v.val().replace(/\,/,".")))};R.validate(t,function(e){if(!e||!e.valid){var t=function(e){e.toggleClass(w,!0),e.toggleClass(j,!1),e.toggleClass(x,!0).delay(1e3).queue(function(){e.toggleClass(x,!1),e.dequeue()})};b.toggleClass(w,!0),b.toggleClass(j,!1);var n=e.context||{},i=n.responseJSON||{},r=i.key;return void t(!o.amount||r!==p&&r!==f&&r!==g?d:v)}v.val()>=0?v.val(parseFloat(v.val().replace(/\,/,"."))):v.hide(100),d.toggleClass(w,!1),v.toggleClass(w,!1),y.val(e.discount&&e.discount.type||""),h.val(e.discount&&e.discount.amount_off||0),C.val(e.discount&&e.discount.unit_off||0),m.val(e.discount&&e.discount.percent_off||0),I.val(e.tracking_id||""),d.prop("disabled",!0),v.prop("disabled",!0),b.prop("disabled",!0),d.toggleClass(j,!0),v.toggleClass(j,!0),b.toggleClass(j,!0),b.toggleClass(w,!1),d.toggleClass(w,!1),d.toggleClass(V,!0),v.toggleClass(V,!0),o&&o.onValidated&&"function"==typeof o.onValidated&&o.onValidated(e)})})}};return"undefined"!=typeof module&&module.exports&&(module.exports=y),y}(window,window.document,window.jQuery);
//# sourceMappingURL=voucherify.min.js.map
